@using Syncrosoft.Framework.Controles.MVC.Script;
@using Syncrosoft.Framework.Controles.Mvc.JQuery.Datatables;
@using SSO.SGP.Web.Areas.RRHH.Controllers;
@using Syncrosoft.Framework.Controles.MVC;
@using SSO.SGP.EntidadesDeNegocio.Vistas;
@model SSO.SGP.EntidadesDeNegocio.ConcursosDeIngresoEvaluaciones

<!--
    CODE GENERATED BY Xeus Technology
    Date:  15/03/2018 10:52:11
    Version: 3
-->
@{
    Layout = null;
    var hash = "form" + Session.GetHashCode();
    var value = "";
}
<!-- SCRIPTS -->
<!-- <script src="ts/ConcursosDeIngreso/Index.js"></script> -->
<!-- /SCRIPTS -->
<script src="~/assets/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<link href="~/assets/plugins/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet" />
<script src="~/assets/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<style>
    .blur-content {
        -webkit-filter: url(#svg-blur);
        filter: url(#svg-blur);
    }

    .hourselect {
        z-index: auto !important;
    }
</style>
@using (Html.BeginForm("Index", "ConcursosDeIngreso", FormMethod.Post, new { id = hash }))
{
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-info">
                    Total de evaluaciones: <strong id="total_evaluaciones"></strong>
                    <div class="btn-group btn-group-solid" style="float:right">
                        <button type="button" id="nueva_evaluacion" class="btn blue" onclick="agregarEvaluacion(this)"><i class="fa fa-plus"></i> Nueva Evaluación</button>
                    </div>

                    @*<a id="NuevaRuta" class="btn blue" style="margin-bottom:20px !important" href="#"><i class="fa fa-plus"></i> Nueva Ruta</a>*@
                </div>
            </div>
        </div>
        <br />
        <div id="div_evaluacion" style="display:none">
            <div class="row">
                <div class="col-md-6">
                    <div class="control-group">
                        <label class="control-label bold" for="Titulo">Descripción</label>
                        <div class="controls">
                            <input type="text" class="col-md-12 form-control" id="descripcion_evaluacion" />
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="control-group">
                        <label class="control-label bold" for="Titulo">Cantidad Preguntas a Mostrar</label>
                        <div class="controls">
                            <input type="text" class="col-md-12 form-control" id="cantidad_preguntas" />
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="control-group">
                        <label class="control-label bold" for="Titulo">Porcentaje de Aprobación</label>
                        <div class="controls">
                            <input type="text" class="col-md-12 form-control" id="porcentaje_aprobacion" />
                        </div>
                    </div>
                </div>
            </div>
            <br />
            <div class="row">
                <div class="col-md-4">
                    <div class="control-group">
                        <label class="control-label" for="description">Inicio y Fin de la evaluación</label>
                        <div class="input-group" id="rango1@(hash)">
                            <input type="hidden" id="id_evaluacion" />
                            <input type="hidden" id="evaluacion_activo" />
                            <input type="text" class="form-control" id="daterange1@(hash)" name="daterange1" readonly value="">
                            <input id="range_1_from@(hash)" name="fechadeinicio" type="hidden" value="" />
                            <input id="range_1_to@(hash)" name="fechadefin" type="hidden" value="" />
                            <span class="input-group-btn">
                                <button id="resetRango1@(hash)" class="btn default date-reset" type="button"><i class="fa fa-times"></i></button>
                            </span>
                            <span class="input-group-btn">
                                <button id="btnRango1" class="btn default date-range-toggle" type="button"><i class="fa fa-calendar"></i></button>
                            </span>
                            <script type="text/javascript">
                                var desde1;
                                var hasta1;
                                var calendario_servicio;

                                $('#resetRango1@(hash)').click(function (e) {
                                    $('#daterange1@(hash)').val("");
                                    $('#range_1_from@(hash)').val("");
                                    $('#range_1_to@(hash)').val("");
                                });

                                var rango1 = $('#daterange1@(hash), #btnRango1').daterangepicker({
                                    opens: 'left',
                                    format: 'DD/MM/YYYY HH:mm',
                                    separator: ' hasta ',
                                    @*@if (Model.range_1_from.HasValue) {
                                <text>
                                startDate: '@Model.range_1_from.Value.ToString()',
                                endDate: '@Model.range_1_to.Value.ToString()',
                                </text>
                            }*@
                                    minDate: '01/01/2019',
                                    maxDate: '01/01/2029',
                                    parentEl: "#rango1@(hash)",
                                    timePicker: true,
                                    timePickerIncrement: 5,
                                    locale: {
                                        "direction": "ltr",
                                        "format": "DD/MM/YYYY HH:mm",
                                        "separator": " - ",
                                        "applyLabel": "Aplicar",
                                        "cancelLabel": "Cancelar",
                                        "fromLabel": "Desde",
                                        "toLabel": "Hasta",
                                        "customRangeLabel": "Custom",
                                        "daysOfWeek": [
                                            "Do",
                                            "Lu",
                                            "Ma",
                                            "Mi",
                                            "Ju",
                                            "Vi",
                                            "Sa"
                                        ],
                                        "monthNames": [
                                            "Enero",
                                            "Febrero",
                                            "Marzo",
                                            "Abril",
                                            "Mayo",
                                            "Junio",
                                            "Julio",
                                            "Agosto",
                                            "Septiembre",
                                            "Octubre",
                                            "Moviembre",
                                            "Diciembre"
                                        ],
                                        "firstDay": 1
                                    },
                                },
                                    function (start, end) {
                                        desde1 = start.toDate();
                                        hasta1 = end.toDate();
                                        console.log("Callback has been called!");
                                        $('#daterange1@(hash)').val(start.format('DD/MM/YYYY HH:mm') + ' - ' + end.format('DD/MM/YYYY'));
                                        $('#range_1_from@(hash)').val(start.format('DD/MM/YYYY HH:mm'));
                                        $('#range_1_to@(hash)').val(end.format('DD/MM/YYYY HH:mm'));
                                    }
                            );
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <input type="button" value="Cerrar" id="Cancelar_Evaluacion" name="Cancelar" class="btn red" />
                <input type="button" value="Guardar" id="Guardar_Evaluacion" name="Guardar" class="btn green" />
                <input type="hidden" Id="Id" value="@ViewBag.Id" />

                <script>
                    $(function () {
                        $("#Cancelar_Evaluacion").click(function (e) {
                            div_evaluacion.hide();
                        });

                        $("#Guardar_Evaluacion").click(function (e) {
                            var id = $("#id_evaluacion").val();
                            var activa = $("#evaluacion_activo").val() == "1";

                            var evaluacion = {
                                Descripcion: $("#descripcion_evaluacion").val(),
                                Concurso: $("#Id").val(),
                                FechaInicio: desde1,
                                FechaFin: hasta1,
                                Porcentaje_Aprobacion: $("#porcentaje_aprobacion").val(),
                                Cantidad_Preguntas: $("#cantidad_preguntas").val(),
                                Id: id,
                                Activa: true
                            };

                            app.Bloquear();
                            $.ajax({
                                type: "POST",
                                url: "/RRHH/ConcursosDeIngreso/guardarEvaluacion",
                                dataType: "json",
                                contentType: "application/json",
                                data: JSON.stringify(evaluacion),
                                success: function (data) {
                                    if (data[0]) {
                                        app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                                        div_evaluacion.hide();
                                        refrescarEvaluaciones();
                                    } else {
                                        app.crearNotificacionError("Error", data[1]);
                                    }
                                },
                                error: function (jqXhr, textStatus, errorThrown) {
                                    alert("Error al procesar formulario ajax");
                                },
                                complete: function () {
                                    app.Desbloquear();
                                }
                            });
                        });
                    });

                </script>

            </div><!--fin form-actions>-->
            <br />
        </div>
        <div class="row">
            <div class="col-md-12">
                <table width="100%" class="table table-bordered table-hover" id="tabla_evaluaciones">
                    <thead>
                        <tr>
                            <th>
                                Descripción
                            </th>
                            <th>
                                Fecha de Inicio
                            </th>
                            <th>
                                Fecha de Fin
                            </th>
                            <th>
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="body_evaluaciones"></tbody>
                </table>
            </div>

        </div>

        <div id="div_preguntas" style="display:none">
            <div class="row">
                <div class="col-md-12">
                    <table width="100%" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th width="90%">
                                    Pregunta
                                </th>
                                <th width="10%">
                                    Activa
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="body_preguntas"></tbody>
                    </table>
                </div>
            </div>
        </div>


        <div id="div_resultados" style="display:none">
            <div class="row">
                <div class="col-md-12">
                    <table width="100%" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th width="55%">
                                    Nombre
                                </th>
                                <th width="20%">
                                    DNI
                                </th>
                                <th width="10%">
                                    % Resultado
                                </th>
                                <th width="15"></th>
                            </tr>
                        </thead>
                        <tbody id="body_resultados"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">
                                    <button type="button" id="generar_excel_resultados" class="btn green">Generar y descargar Excel</button>
                                    <button type="button" id="ocultar_resultados" class="btn blue">Ocultar Resultados</button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div>
}

<div class="modal fade" id="ModalEvaluacion" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog modal-wide">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title" id="titulo_evaluacion">Agregar una nueva Evaluación</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">

                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>



<script type="text/javascript">
    var modal = new SyncroModal("#ModalEvaluacion");
    var div_evaluacion = $("#div_evaluacion");
    var div_preguntas = $("#div_preguntas");
    var body_preguntas = $("#body_preguntas");
    var pregunta_actual = 0;
    var evaluacion_actual = 0;
    var interval;
    var examen_seleccionado = 0;

    var body_evaluaciones = $("#body_evaluaciones");

    $(function () {
        app.Desbloquear();
        refrescarEvaluaciones();

        $("#generar_excel_resultados").click(function (e) {
            e.preventDefault();
            
            var sql = "select * from EvaluacionesResultadosExcel where id = " + examen_seleccionado;    

            window.open("/rrhh/reportes/excelsintitulo/?query=" + sql + "&filename=resultados_examen");
        });

        $("#ocultar_resultados").click(function (e) {
            e.preventDefault();
            $("#div_resultados").hide();
        });

        $("button[data-tipo=guardar_texto_respuesta]").die("click");

        $("button[data-tipo=quitar_pregunta]").die("click");
        $("button[data-tipo=quitar_pregunta]").live("click", function (e) {
            e.preventDefault();
            var id = $(this).data("id");

            bootbox.confirm("Está seguro que desea desactivar la pregunta", function (result) {
                if (result) {
                    $.ajax({
                        type: "POST",
                        url: "/RRHH/ConcursosDeIngreso/desactivarPregunta",
                        dataType: "json",
                        contentType: "application/json",
                        data: JSON.stringify({ id: id, activa:false }),
                        success: function (data) {
                            if (data[0]) {
                                $("tr[data-pregunta=" + id + "]").remove();
                                app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                            } else {
                                app.crearNotificacionError("Error", data[1]);
                            }
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            alert("Error al procesar formulario ajax");
                        },
                        complete: function () {
                            app.Desbloquear();
                        }
                    });
                }

            });
        });
    });

    @*var viewIndex = new ConcursosDeIngreso.ts.Index("@(hash)");
    oConcursosDeIngreso.setIndex(viewIndex);
    viewIndex.setConcursosDeIngreso(dtConcursosDeIngreso);*@

    function cargarResultados(examen) {
        examen_seleccionado = examen;

        $("#div_resultados").show();

        $.get("/rrhh/concursosdeingreso/getresultados/" + examen, null, function (data) {

            $("#body_resultados").empty();

            data.forEach(function (element) {

                var tr = `<tr><td><strong>${element.nombre}</strong></td><td>${element.dni}</td><td>${element.resultado}</td><td><a href="#" data-id="${element.id}" onclick="verResultado(${element.id})">VER</a></td></tr>`;

                $("#body_resultados").append(tr);

            });

        });

    }

    function corregirPendientes(id) {
        bootbox.confirm("Atención!, va a corregir exámenes pendietes", function (result) {
            if (result) {
                $.ajax({
                    type: "POST",
                    url: "/RRHH/ConcursosDeIngreso/CorregirPendientes",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify({ id: id }),
                    success: function (data) {
                        if (data[0]) {
                            app.crearNotificacionSuccess("Operación satisfactoria", "Se corrigieron "+ data[2] + " exámenes");
                        } else {
                            app.crearNotificacionError("Error", data[1]);
                        }
                    },
                    error: function (jqXhr, textStatus, errorThrown) {
                        alert("Error al procesar formulario ajax");
                    },
                    complete: function () {
                        app.Desbloquear();
                    }
                });
            }
        });
    }

    function verResultado(id) {
        @if (SSO.SGP.Web.SessionHelper.NombrePersona == "descuredo" || SSO.SGP.Web.SessionHelper.NombrePersona == "jotero")
            {
                @: window.open("http://concursos.justicialapampa.gob.ar/resultado/" + id);
                    }

    }


    function refrescarEvaluaciones(id) {
        body_evaluaciones.empty();

        $.get("/rrhh/concursosdeingreso/getevaluaciones/" + @ViewBag.Id, null, function (data) {
            if (data.length > 0) {
                data.forEach(function (e) {
                    var tr = `<tr data-id="${e.Id}" data-descripcion="${e.Descripcion}" data-porcentaje="${e.Porcentaje_Aprobacion}" data-cantidad="${e.Cantidad_Preguntas}" data-inicio="${app.formatearFechaYHora(e.FechaInicio)}" data-fin="${app.formatearFechaYHora(e.FechaFin)}">
                <td>${e.Descripcion}</td>
                <td>${app.formatearFechaYHora(e.FechaInicio)}</td>
                <td>${app.formatearFechaYHora(e.FechaFin)}</td>
                <td>
                    <a href="#" data-tipo="editar_evaluacion" onclick="editarEvaluacion(this)" data-id="${e.Id}" ><img src="/assets/img/icons/16x16/edit.png" /></a>&nbsp;
                    <a href="#" data-tipo="editar_preguntas" data-id="${e.Id}" onclick="editarPreguntas(this)" data-id="${e.Id}"><img src="/assets/img/icons/16x16/list.png" /></a>
                    <a href="#" data-tipo="desactivar_evaluacion" data-id="${e.Id}" data-activo="${e.Activa ? '1' : '0'}" onclick="desactivarEvaluacion2(this)" data-id="${e.Id}"><img src="/assets/img/icons/16x16/${e.Activa ? 'refresh.fw' : 'anular'}.png" /></a>
                    <a href="#" data-tipo="recordar_evaluacion" data-id="${e.Id}" data-activo="${e.Activa ? '1' : '0'}" onclick="enviarRecordatorio(this)" data-id="${e.Id}"><img src="/assets/img/icons/16x16/mail.png" /></a>
                    <a href="#" data-tipo="ver_resultados" onclick="cargarResultados(${e.Id})" data-id="${e.Id}"><img src="/assets/img/icons/16x16/finish.fw.png" /></a>
                    <a href="#" data-tipo="auto_corregir" onclick="corregirPendientes(${e.Id})" data-id="${e.Id}"><img src="/assets/img/icons/16x16/confirmar.fw.png" /></a>
                </td>`;
                    body_evaluaciones.append(tr);
                });
            } else {
                body_evaluaciones.append(`<tr><td colspan='4'>El concurso aún no tiene evaluaciones <a href="#" onclick="agregarEvaluacion(this)">Agregar una evaluación</a></td></tr>`);
            }
        });
    }

    function enviarRecordatorio(el) {
        var id = $(el).data("id");
        bootbox.confirm("Está seguro que desea enviar recordatorio de este examen?", function (result) {
            if (result) {
                $.ajax({
                    type: "POST",
                    url: "/RRHH/ConcursosDeIngreso/enviarRecordatorio",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify({ id: id }),
                    success: function (data) {
                        if (data[0]) {
                            app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                        } else {
                            app.crearNotificacionError("Error", data[1]);
                        }
                    },
                    error: function (jqXhr, textStatus, errorThrown) {
                        alert("Error al procesar formulario ajax");
                    },
                    complete: function () {
                        app.Desbloquear();
                    }
                });
            }
        });
    }

    function agregarEvaluacion(el) {
        $("#id_evaluacion").val("0");
        $("#evaluacion_activo").val("1");
        div_evaluacion.show();
        $("#descripcion_evaluacion").focus();
    }

    function editarEvaluacion(el) {
        var id = $(el).data("id");
        var trdata = $("tr[data-id=" + id + "]");
        var descripcion = $(trdata).data("descripcion");
        var inicio = $(trdata).data("inicio");
        var fin = $(trdata).data("fin");
        var porcentaje =  $(trdata).data("porcentaje");
        var cantidad= $(trdata).data("cantidad");
        $("#evaluacion_activo").val($("a[data-tipo=desactivar_evaluacion][data-id=" + id + "]").data("activo"));

        desde1 = inicio;
        hasta1 = fin;

        $('#daterange1@(hash)').val(inicio + ' - ' + fin);

        $("#id_evaluacion").val(id);
        $("#descripcion_evaluacion").val(descripcion);
        $("#descripcion_evaluacion").focus();
        div_evaluacion.show();
        $("#descripcion_evaluacion").focus();
        $("#cantidad_preguntas").val(cantidad);
        $("#porcentaje_aprobacion").val(porcentaje);
    }

    function editarPreguntas(el) {

        var id = $(el).data("id");
        evaluacion_actual = id;
        console.log("Id de evaluacion a buscar" + id);

        div_evaluacion.hide();
        div_preguntas.show();

        refrescarPreguntas(id);

    }

    function desactivarEvaluacion(el) {

        var activa = $(el).data("activo");
        var id = $(el).data("id");
        var bactiva = activa == "1" ? false : true;

        console.log("Id: " + id);
        console.log("Activa: " + bactiva);


        app.Bloquear();
        $.ajax({
            type: "POST",
            url: "/RRHH/ConcursosDeIngreso/desactivarExamen",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({ id: id, activa: bactiva }),
            success: function (data) {
                if (data[0]) {
                    app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                    $(el).attr("data-activo", bactiva ? "1" : "0");
                    $(el).find("img").attr("src", bactiva ? "/assets/img/icons/16x16/refresh.fw.png" : "/assets/img/icons/16x16/anular.png");
                } else {
                    app.crearNotificacionError("Error", data[1]);
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                alert("Error al procesar formulario ajax");
            },
            complete: function () {
                app.Desbloquear();
            }
        });
    }

    function desactivarRespuesta(el) {

        var activa = $(el).data("activo");
        var id = $(el).data("id");
        var bactiva = activa == "1" ? false : true;

        app.Bloquear();
        $.ajax({
            type: "POST",
            url: "/RRHH/ConcursosDeIngreso/desactivarrespuesta",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({ id: id, activa: bactiva }),
            success: function (data) {
                if (data[0]) {
                    app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                    $(el).data("activo", bactiva ? "1" : "0");
                    $(el).find("img").attr("src", bactiva ? "/assets/img/icons/16x16/refresh.fw.png" : "/assets/img/icons/16x16/anular.png");
                } else {
                    app.crearNotificacionError("Error", data[1]);
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                alert("Error al procesar formulario ajax");
            },
            complete: function () {
                app.Desbloquear();
            }
        });
    }

    function actualizarRespuesta(el) {

        var es_correcta = $(el).is(":checked");
        var id = $(el).data("id");

        app.Bloquear();
        $.ajax({
            type: "POST",
            url: "/RRHH/ConcursosDeIngreso/actualizarRespuesta",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({ id: id, es_correcta: es_correcta}),
            success: function (data) {
                if (data[0]) {

                    app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                    if (es_correcta)
                        $(el).prop("checked", "checked");
                    else
                        $(el).prop("checked", false);

                } else {
                    app.crearNotificacionError("Error", data[1]);
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                alert("Error al procesar formulario ajax");
            },
            complete: function () {
                app.Desbloquear();
            }
        });
    }

    function guardarPregunta(el) {

        var txt_pregunta = $("#txt_pregunta").val();

        var pregunta = {
            Id: 0,
            Pregunta: txt_pregunta,
            Activa: true,
            Evaluacion: evaluacion_actual,
            Orden: 0
        };

        app.Bloquear();
        $.ajax({
            type: "POST",
            url: "/RRHH/ConcursosDeIngreso/guardarPregunta",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({ pregunta: pregunta }),
            success: function (data) {
                if (data[0]) {
                    app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                    var tr_respuestas = `<tr data-pregunta="${data[2]}" onclick="mostrarRespuestas(${data[2]})" style="background-color:#d9efff"><td><strong>${txt_pregunta}</strong></td><td></td>
                    <td><button data-id="${data[2]}" data-tipo="quitar_pregunta" class="btn red btn-xs">-</button></td></tr>`;


                    tr_respuestas += `<tr data-tipo='respuestas' data-pregunta="${data[2]}" style="display:none">
                                        <td>
                                            <table width="100%" class="table" id="respuestas_${data[2]}">
                                                <thead><tr><th width="80%">Respuesta</th><th width="10%">Correcta</th><th width="10%"></th></tr></thead>
                                                <tbody>
                                                <tr>
                                                    <td><input type="text" id="txt_respuesta_${data[2]}" class="form-control col-md-12" /></td>
                                                    <td><input type="checkbox" id="chk_respuesta" /></td>
                                                    <td><button type="button" class="btn green btn-xs" data-tipo="guardar_pregunta" onclick="guardarRespuesta()">+</button></td>
                                                <tr>
                                            </table>
                                        </td>
                                       </tr>`;
                    body_preguntas.append(tr_respuestas);
                    $("#tr_sin_preguntas").remove();
                    $("#txt_pregunta").val("");

                } else {
                    app.crearNotificacionError("Error", data[1]);
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                alert("Error al procesar formulario ajax");
            },
            complete: function () {
                app.Desbloquear();
            }
        });
    }

    function guardarRespuesta(el) {

        var txt_respuesta = $("#txt_respuesta_"+pregunta_actual).val();
        var es_correcta = $("#chk_respuesta").is(":checked");

        var respuesta = {
            Id: 0,
            Respuesta: txt_respuesta,
            EsCorrecta: es_correcta,
            Pregunta: pregunta_actual
        };

        app.Bloquear();
        $.ajax({
            type: "POST",
            url: "/RRHH/ConcursosDeIngreso/guardarRespuesta",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({ respuesta: respuesta }),
            success: function (data) {
                if (data[0]) {
                    app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                    //refrescarPreguntas(pregunta_actual);
                    $("#respuestas_" + pregunta_actual).append(`<tr data-tipo="respuesta" data-respuesta="${data[2]}">
                                                <td>${txt_respuesta}</td>
                                                <td><input type="checkbox" data-id="${data[2]}" data-tipo="chk_${data[2]}" ${es_correcta ? 'checked' : ''} onclick="actualizarRespuesta(this)"></td>
                                                <td><button type="button" data-id="${data[2]}" onclick="desactivarRespuesta(this) class="btn red btn-xs">-</button></td>
                                             </tr>`);
                    $("#no_respuesta_" + pregunta_actual).hide();
                    $("#txt_respuesta_"+pregunta_actual).val("");                    
                } else {
                    app.crearNotificacionError("Error", data[1]);
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                alert("Error al procesar formulario ajax");
            },
            complete: function () {
                app.Desbloquear();
            }
        });
    }

    function mostrarRespuestas(pregunta) {
        pregunta_actual = pregunta;
        console.log("respuestas  de pregunta: " + pregunta);
        $("tr[data-tipo=respuestas]").hide();
        $("tr[data-pregunta]").addClass("blur-content");
        $("tr[data-pregunta="+pregunta+"]").removeClass("blur-content");
        $("tr[data-tipo=respuestas][data-pregunta=" + pregunta + "]").show('slow');
    }

    function editarTextoRespuesta(el) {

        var id = $(el).data("id");
        var texto = $("#span_respuesta_" + id).text();

        var edit = `<textarea data-trigger="quitar" id="texto_pregunta_${id}" class="form-control col-md-12" style="width:100%" rows="3">${texto}</textarea><button type="button" data-id="${id}" id="btn_saveTextoRespuesta_${id}" data-trigger="quitar" class="btn green btn-xs" onclick="saveTextoRespuesta(${id})">Guardar</button>`;
        $(el).after(edit);

    }

    function saveTextoRespuesta(id) {

        var respuesta = $("#texto_pregunta_" + id).val();

        app.Bloquear();
        $.ajax({
            type: "POST",
            url: "/RRHH/ConcursosDeIngreso/guardarTextoRespuesta",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({ id: id, texto: respuesta }),
            success: function (data) {
                if (data[0]) {
                    app.crearNotificacionSuccess("Operación satisfactoria", data[1]);
                    //refrescarPreguntas(pregunta_actual);
                    $("#span_respuesta_" + id).text(respuesta);
                    $("#texto_pregunta_" + id).remove();
                    $("#btn_saveTextoRespuesta_" + id).remove();
                } else {
                    app.crearNotificacionError("Error", data[1]);
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                alert("Error al procesar formulario ajax");
            },
            complete: function () {
                app.Desbloquear();
            }
        });


    }

    function refrescarPreguntas(id) {

        body_preguntas.empty();
        evaluacion_actual = id;

        $.get("/rrhh/concursosdeingreso/getpreguntas/?evaluacion=" + evaluacion_actual, null, function (data) {

            body_preguntas.append(`<tr><td><textarea placeholder="Escriba aquí el texto de la nueva pregunta..." id="txt_pregunta" class="form-control col-md-12" style="width:100%" rows="2" ></textarea></td><td></td><td><button type="button" class="btn green btn-xs" data-tipo="guardar_pregunta" onclick="guardarPregunta()">+</button></td></tr>`);

            if (data.length > 0) {

                data.forEach(function (e) {

                    var tr_respuestas = `<tr style="background-color:#d9efff" data-pregunta="${e.id}" onclick="mostrarRespuestas(${e.id})"><td><strong>${e.pregunta}</strong></td><td></td>
                    <td><button data-id="${e.id}" data-tipo="quitar_pregunta" class="btn red btn-xs">-</button></td></tr>`;

                    tr_respuestas += `<tr data-tipo='respuestas' data-pregunta="${e.id}" style="display:none">
                                        <td>
                                            <table width="100%" class="table" id="respuestas_${e.id}">
                                                <thead><tr><th width="80%">Respuesta</th><th width="10%">Correcta</th><th width="10%"></th></tr></thead>
                                                <tbody>
                                                <tr>
                                                    <td><textarea id="txt_respuesta_${e.id}" class="form-control col-md-12" style="width:100%" rows="2" /></td>
                                                    <td><input type="checkbox" id="chk_respuesta" /></td>
                                                    <td><button type="button" class="btn green btn-xs" data-tipo="guardar_pregunta" onclick="guardarRespuesta()">+</button></td>
                                                <tr>`;



                    /*******  RESPUESTAS  *******/
                    if (e.respuestas.length > 0) {
                        e.respuestas.forEach(function (r) {
                            var respuesta = `<tr data-tipo="respuesta" data-respuesta="${r.id}">
                                                <td><span id="span_respuesta_${r.id}">${r.respuesta}</span> &nbsp;  <button type="button" class="btn yellow btn-xs" style="align:right" data-id="${r.id}" onclick="editarTextoRespuesta(this)" data-tipo="editar_texto_respuesta">Editar texto</button></td>
                                                <td><input type="checkbox" data-id="${r.id}" data-tipo="chk_${r.id}" ${r.es_correcta ? "checked" : ""} onclick="actualizarRespuesta(this)"></td>
                                                <td><a href="#" data-tipo="desactivar_respuesta" data-id="${r.id}" data-activo="${r.activa ? '1' : '0'}" onclick="desactivarRespuesta(this)" data-id="${r.Id}"><img src="/assets/img/icons/16x16/${r.activa ? 'refresh.fw' : 'anular'}.png" /></a></td>
                                             </tr>`;
                            tr_respuestas += respuesta;
                        });
                    } else {
                        tr_respuestas += `<tr><td colspan="3" id="no_respuestas_${e.id}">Aún no hay respuestas</td></tr>`;
                    }
                    /*******  RESPUESTAS  *******/

                    tr_respuestas += "</tbody></table>"
                    body_preguntas.append(tr_respuestas);

                });

            } else {


                //var tr_respuestas = `<tr>
                //                        <td colspan="2"><input type="text" class="form-control col-md-12" id="txt_pregunta"></td>
                //                        <!-- <td colspan="2"><input type="checkbox" data-tipo="chk" id="chk_pregunta"></td> --!>
                //                        <td><button type="button" class="btn green btn-xs" data-tipo="guardar_pregunta" onclick="guardarPregunta()">+</button></td>
                //                    </tr>`;
                //body_preguntas.append(tr_respuestas);
                body_preguntas.append(`<tr id="tr_sin_preguntas"><td colspan='3'>Aún no hay preguntas en este examen. <a href="#" onclick=>Agregar una pregunta</a></td></tr>`);
            }
        });

    }


</script>

<svg id="svg-filter">
    <filter id="svg-blur">
        <feGaussianBlur in="SourceGraphic" stdDeviation="4"></feGaussianBlur>
    </filter>
</svg>